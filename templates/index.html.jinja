<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <style>
        div {
            width: 25%;
            margin: .5em;
            box-shadow: 2px 2px 10px #0002;
            border-radius: 5px;
        }

        #locations-form-div {
            border: 2px solid black;
            padding: 2em;
        }

        .error-block {
            border: 4px solid red;
            color: #622;
            padding: 2em;
        }

        .search-results {
            height: 30em;
            overflow-y: scroll;
            padding: 2em;
            border: 2px solid black;
            display: flex;
            flex-direction: column;
        }

        .search-header {
            position: sticky;
            top: 0;
            background: #fff;
            z-index: 9999;
            width: 100%;
            border-bottom: 2px solid black;
            margin: 0;
        }

        .search-result {
            border: 2px solid black;
            border-radius: 5px;
            padding: 1em;
            transition: all ease-in-out 0.1s;
        }

        .search-result:hover {
            background-color: #bbb;
            transform: translateY(-5px);
        }

        .search-result:active {
            background-color: #ddd;
            transform: translateY(2px);
        }

        form#locations-form {
            display: flex;
            flex-direction: column;
        }
    </style>
</head>

<body>
    <div id="locations-form-div">
        <form id="locations-form" action="/" method="get">
            <label for="start-loc">Start Location:</label>
            <input type="text" id="start-loc" name="s">
            <label for="dest-loc">Destination Location:</label>
            <input type="text" id="dest-loc" name="d">
            <input type="submit" id="search-button" value="Search Locations">
        </form>
    </div>
    {% if start_res and dest_res %}
        <div class="search-results" id="start-results" submitted="false">
            <div class="search-header">
                <h3>Start Location Results</h3>
            </div>
            {% for choice in start_res.choices %}
                <p class="search-result" resulttype="start" index="{{ choice[1] }}">{{ choice[0] }}</p>
            {% endfor %}
        </div>
        <div class="search-results" id="dest-results" submitted="false">
            <div class="search-header">
                <h3>Destination Location Results</h3>
            </div>
            {% for choice in dest_res.choices %}
                <p class="search-result" resulttype="dest" index="{{ choice[1] }}">{{ choice[0] }}</p>
            {% endfor %}
        </div>
    {% elif start_res and not dest_res %}
        <div class="error-block">
            <h3>:(</h3>
            <p>Please provide both locations</p>
        </div>
    {% elif dest_res and not start_res %}
        <div class="error-block">
            <h3>:(</h3>
            <p>Please provide both locations</p>
        </div>
    {% endif %}
    <script>
        let startCoords = null;
        let destCoords = null;

        document.querySelector("input#search-button")
        document.querySelectorAll(".search-result").forEach((element)=>{
            element.onclick = function resultClick(e){
                let loctype = e.target.attributes.resulttype.value;
                let index = e.target.attributes.index.value
                fetch(`/getLocationByIndex?i=${index}&t=${loctype}`)
                    .then(resp=> {
                        if(!resp.ok) {
                            throw new Error(`HTTP error! Status code: ${resp.status}; ${resp.statusText}`);
                        }
                        return resp.json();
                    })
                    .then(data => {


                        if (data.loctype === "start") {
                            startCoords = data.coords
                        } else if (data.loctype === "dest") {
                            destCoords = data.coords
                        }
                        console.log(startCoords, destCoords)
                        // e.target.parentNode.setAttribute("submitted", "true")
                        if (startCoords && destCoords){
                            showCalculateButton()
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching data:', error); // Handle errors
                    });
                };
                // let startResDiv = document.querySelector("div#start-results");
                // let destResDiv = document.querySelector("div#dest-results");
                // let startResDivSubmitted = (startResDiv.attributes.submitted.value === "true");
                // let destResDivSubmitted = (destResDiv.attributes.submitted.value === "true");
                // if(startResDivSubmitted && destResDivSubmitted){
                //     startResDiv.style.display = "none";
                //     destResDiv.style.display = "none";
                // }
            });

        function showCalculateButton() {
            let locationsFormDiv = document.getElementById("locations-form-div");
            let calculateButton = document.createElement("input");
            let calculateDiv = document.createElement("div");
            calculateButton.setAttribute("type", "button");
            calculateButton.setAttribute("id", "calculate-button");
            calculateButton.setAttribute("value", "Calculate\u0020Route(s)");
            calculateButton.onclick = ()=>{
                window.location.assign(`/calculate?s=${startCoords.lon},${startCoords.lat}&d=${destCoords.lon},${destCoords.lat}`)
            }
            calculateButton.setAttribute
            calculateDiv.setAttribute("id", "calculate-div");
            calculateDiv.append(calculateButton);
            locationsFormDiv.appendChild(calculateDiv);
        }
    </script>
</body>

</html>