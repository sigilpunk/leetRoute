<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>leetRoute - Home</title>
    <link rel="icon" href="{{ url_for('static', filename='/images/favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='/css/base.light.css')}}" id="light-theme">
    <link rel="stylesheet" href="{{ url_for('static', filename='/css/base.dark.css')}}" id="dark-theme" disabled>
    <link rel="stylesheet" href="{{ url_for('static', filename='/css/theme-button.css')}}">
</head>

<body>
    <div id="header">
        <a href="/"><img id="header-logo" src="{{ url_for('static', filename='/images/favicon.ico') }}"></a>
        <h1>leetRoute v{{ webapp_version }}</h1>
    </div>

    <div id="locations-form-div">
        <form id="locations-form" action="/" method="get">
            <label for="start-loc">Start Location:</label>
            <div id="start-loc-container">
                <input type="text" id="start-loc" name="s" autocomplete="off">
                <button type="button" class="clear-button" id="start-clear" title="Clear selection">×</button>
                <div id="start-predictions" class="predictions-dropdown"></div>
            </div>

            <label for="dest-loc">Destination Location:</label>
            <div id="dest-loc-container">
                <input type="text" id="dest-loc" name="d" autocomplete="off">
                <button type="button" class="clear-button" id="dest-clear" title="Clear selection">×</button>
                <div id="dest-predictions" class="predictions-dropdown"></div>
            </div>

            <!--<input type="submit" id="search-button" value="Search Locations">-->
        </form>

        <div id="calculate-div">
            <button id="calculate-button" disabled>Calculate Route(s)</button>
        </div>
    </div>

    {% if start_res and dest_res %}
        <div class="search-results" id="start-results" submitted="false">
            <div class="search-header">
                <h3>Start Location Results</h3>
            </div>
            {% for choice in start_res.choices %}
                <p class="search-result" resulttype="start" index="{{ choice[1] }}">{{ choice[0] }}</p>
            {% endfor %}
        </div>

        <div class="search-results" id="dest-results" submitted="false">
            <div class="search-header">
                <h3>Destination Location Results</h3>
            </div>
            {% for choice in dest_res.choices %}
                <p class="search-result" resulttype="dest" index="{{ choice[1] }}">{{ choice[0] }}</p>
            {% endfor %}
        </div>
    {% elif start_res and not dest_res %}
        <div class="error-block">
            <h3>:(</h3>
            <p>Please provide both locations</p>
        </div>
    {% elif dest_res and not start_res %}
        <div class="error-block">
            <h3>:(</h3>
            <p>Please provide both locations</p>
        </div>
    {% endif %}
        <div class="warn-block">
            <h3>Hey!</h3>
            <p>This application is in <strong>SUPER-MEGA-ALPHA&#8482;</strong></p>
            <p>Lots of things WILL be broken or just bad.</p>
            <p>feel free to yell at me at <a href="https://github.com/sigilpunk/leetRoute">https://github.com/sigilpunk/leetRoute/</a></p>
        </div>
        <div class="version-block-container">
            <div class="version-block">
                <p>Version: {{ base_version }}</p>
                <p>Engine Version: {{ engine_version }}</p>
                <p>Webapp Version: {{ webapp_version }}</p>
            </div>
        </div>
        <div id="theme-button-container">
            
            <button id="theme-button" state="light">
            <svg class="moon-icon" width="300" height="300" viewBox="0 0 300 300" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M150.696 44.9968C153.44 41.0163 153.641 35.8105 151.215 31.6291C148.789 27.4478 144.169 25.0405 139.351 25.4474C75.2939 30.8585 25 84.549 25 150C25 219.035 80.9644 275 150 275C215.45 275 269.141 224.705 274.552 160.648C274.959 155.83 272.551 151.21 268.37 148.784C264.189 146.358 258.984 146.56 255.002 149.304C242.926 157.628 228.301 162.5 212.5 162.5C171.079 162.5 137.5 128.921 137.5 87.4995C137.5 71.6986 142.373 57.0734 150.696 44.9968Z" fill="white"/>
                </svg>
                <svg class="sun-icon" width="300" height="300" viewBox="0 0 300 300" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M146.875 68.75C139.971 68.75 134.375 63.1535 134.375 56.25V25C134.375 18.0965 139.971 12.5 146.875 12.5H153.125C160.029 12.5 165.625 18.0965 165.625 25V56.25C165.625 63.1535 160.029 68.75 153.125 68.75H146.875Z" fill="white"/>
                    <path d="M205.242 90.3372C200.361 85.4557 200.361 77.5411 205.242 72.6596L227.34 50.5625C232.221 45.6809 240.136 45.6809 245.017 50.5625L249.436 54.9819C254.319 59.8635 254.319 67.778 249.436 72.6596L227.34 94.7566C222.459 99.6382 214.544 99.6382 209.662 94.7566L205.242 90.3372Z" fill="white"/>
                    <path d="M231.25 146.875C231.25 139.971 236.846 134.375 243.75 134.375H275C281.904 134.375 287.5 139.971 287.5 146.875V153.125C287.5 160.029 281.904 165.625 275 165.625H243.75C236.846 165.625 231.25 160.029 231.25 153.125V146.875Z" fill="white"/>
                    <path d="M209.66 205.242C214.541 200.361 222.456 200.361 227.338 205.242L249.435 227.34C254.316 232.221 254.316 240.136 249.435 245.017L245.015 249.436C240.134 254.319 232.219 254.319 227.338 249.436L205.24 227.34C200.359 222.459 200.359 214.544 205.24 209.662L209.66 205.242Z" fill="white"/>
                    <path d="M153.125 231.25C160.029 231.25 165.625 236.846 165.625 243.75V275C165.625 281.904 160.029 287.5 153.125 287.5H146.875C139.971 287.5 134.375 281.904 134.375 275V243.75C134.375 236.846 139.971 231.25 146.875 231.25H153.125Z" fill="white"/>
                    <path d="M94.7574 209.663C99.6389 214.544 99.6389 222.459 94.7574 227.34L72.6603 249.438C67.7788 254.319 59.8641 254.319 54.9826 249.438L50.5631 245.018C45.6816 240.136 45.6816 232.223 50.5631 227.34L72.6603 205.244C77.5418 200.361 85.4564 200.361 90.3379 205.244L94.7574 209.663Z" fill="white"/>
                    <path d="M68.75 153.125C68.75 160.029 63.1535 165.625 56.25 165.625H25C18.0965 165.625 12.5 160.029 12.5 153.125V146.875C12.5 139.971 18.0965 134.375 25 134.375H56.25C63.1535 134.375 68.75 139.971 68.75 146.875V153.125Z" fill="white"/>
                    <path d="M90.3403 94.7574C85.4588 99.6389 77.5441 99.6389 72.6626 94.7574L50.5655 72.6603C45.684 67.7788 45.684 59.8641 50.5655 54.9826L54.985 50.5631C59.8665 45.6816 67.781 45.6816 72.6626 50.5631L94.7598 72.6603C99.6413 77.5418 99.6413 85.4564 94.7598 90.3379L90.3403 94.7574Z" fill="white"/>
                    <path d="M87.5 150C87.5 115.482 115.482 87.5 150 87.5C184.517 87.5 212.5 115.482 212.5 150C212.5 184.517 184.517 212.5 150 212.5C115.482 212.5 87.5 184.517 87.5 150Z" fill="white"/>
                </svg>
            </button>
        </div>
    <script>
        let startCoords = null;
        let destCoords = null;
        let calculateButton = document.getElementById("calculate-button");

        calculateButton.onclick = () => {
            window.location.assign(`/calculate?s=${startCoords.lon},${startCoords.lat}&d=${destCoords.lon},${destCoords.lat}`);
        };

        function checkSelected() {
            let startResults = document.querySelectorAll('.search-result[resulttype="start"]');
            let destResults = document.querySelectorAll('.search-result[resulttype="dest"]');
            let startSelected = Array.from(startResults).some(e => e.classList.contains("selected"));
            let destSelected = Array.from(destResults).some(e => e.classList.contains("selected"));
            return startSelected && destSelected;
        }

        document.querySelectorAll(".search-result").forEach((element) => {
            element.onclick = function (e) {
                let loctype = e.target.getAttribute("resulttype");
                let index = e.target.getAttribute("index");

                e.target.classList.toggle("selected");
                fetch(`/getLocationByIndex?i=${index}&t=${loctype}`)
                    .then(resp => {
                        if (!resp.ok) {
                            throw new Error(`HTTP error! Status code: ${resp.status}; ${resp.statusText}`);
                        }
                        return resp.json();
                    })
                    .then(data => {
                        if (data.loctype === "start" && e.target.classList.contains("selected")) {
                            startCoords = data.coords;
                        } else if (data.loctype === "dest" && e.target.classList.contains("selected")) {
                            destCoords = data.coords;
                        }
                        calculateButton.disabled = !checkSelected();
                    })
                    .catch(error => {
                        console.error('Error fetching data:', error);
                    });
            };
        });

        // Predictive search functionality
        let searchTimeout = null;
        let DEBOUNCE_DELAY = 300;

        function setupPredictiveSearch(inputId, dropdownId, clearButtonId, locationType) {
            let input = document.getElementById(inputId);
            let dropdown = document.getElementById(dropdownId);
            let clearButton = document.getElementById(clearButtonId);

            // Clear button functionality
            clearButton.onclick = () => {
                input.value = '';
                input.disabled = false;
                input.classList.remove('selected');
                clearButton.classList.remove('show');
                
                if (locationType === 'start') {
                    startCoords = null;
                } else {
                    destCoords = null;
                }
                
                // Disable calculate button if both aren't selected
                calculateButton.disabled = !(startCoords && destCoords);
                input.focus();
            };

            input.addEventListener('input', (e) => {
                let query = e.target.value.trim();
                
                clearTimeout(searchTimeout);
                
                if (query.length < 2) {
                    dropdown.classList.remove('show');
                    dropdown.innerHTML = '';
                    return;
                }

                searchTimeout = setTimeout(() => {
                    fetch(`/predictiveSearch?q=${encodeURIComponent(query)}`)
                        .then(resp => resp.json())
                        .then(predictions => {
                            dropdown.innerHTML = '';
                            
                            if (predictions.length === 0) {
                                dropdown.classList.remove('show');
                                return;
                            }

                            predictions.forEach((pred) => {
                                let item = document.createElement('div');
                                item.className = 'prediction-item';
                                item.textContent = pred.name;
                                item.dataset.coords = JSON.stringify(pred.coords);
                                item.dataset.name = pred.name;
                                
                                item.onclick = () => {
                                    // Fill input with display name
                                    input.value = pred.name;
                                    
                                    // Store coordinates
                                    if (locationType === 'start') {
                                        startCoords = pred.coords;
                                    } else {
                                        destCoords = pred.coords;
                                    }
                                    
                                    // Lock the field and style it
                                    input.disabled = true;
                                    input.classList.add('selected');
                                    clearButton.classList.add('show');
                                    
                                    dropdown.classList.remove('show');
                                    dropdown.innerHTML = '';
                                    
                                    // Enable calculate button if both locations selected
                                    if (startCoords && destCoords) {
                                        calculateButton.disabled = false;
                                    }
                                };
                                
                                dropdown.appendChild(item);
                            });
                            
                            dropdown.classList.add('show');
                        })
                        .catch(error => {
                            console.error('Predictive search error:', error);
                        });
                }, DEBOUNCE_DELAY);
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });

            // Close dropdown on Escape key
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    dropdown.classList.remove('show');
                }
            });
        }

        // Initialize predictive search for both fields
        setupPredictiveSearch('start-loc', 'start-predictions', 'start-clear', 'start');
        setupPredictiveSearch('dest-loc', 'dest-predictions', 'dest-clear', 'dest');
    </script>
    <script>
        function checkLocationAbility(){
            if("gelocation" in navigator){
                return true
            } else {
                return false
            }
        }
        function getDevicePosition(){
            let pos;
            navigator.geolocation.getCurrentPosition((position) => {
                pos = position;
            })
            console.log(pos)
            return pos
        }
        function reverseGeocodeDevicePosition(){
            let position = getDevicePosition();
            let coords = position.coords;
            fetch(`https://photon.komoot.io/reverse?lon=${coords.longitude}&lat=${coords.latitude}`)
                .then(resp => {
                    if (!resp.ok) {
                        throw new Error(`HTTP error! Status code: ${resp.status}; ${resp.statusText}`);
                    }
                    return resp.json();
                })
                .then(data => {
                    console.log(data);
                })
                .catch(error => {
                        console.error('Error fetching data:', error);
                });
        }
    </script>
    <script>
    function elementPosition(element) {
        let rect = element.getBoundingClientRect();
        return rect
    }
    let animBtn = document.getElementById("calculate-button");
    animBtn.addEventListener('click', () => {
        var btnPos = elementPosition(animBtn);
        var btnStyleEle = document.createElement("style");
        btnStyleEle.innerText = `
        #calculate-button.loading::after{
            left: calc(${animBtn.offsetLeft}px + calc(${animBtn.offsetWidth}px / 2.25));
            top: calc(${animBtn.offsetTop}px + calc(${animBtn.offsetHeight}px / 4));
        }
        `
        animBtn.parentNode.appendChild(btnStyleEle);
        animBtn.classList.add("loading");
    });
    </script>
    <script src="{{ url_for('static', filename='/js/theme-button.js')}}"></script>
</body>

</html>